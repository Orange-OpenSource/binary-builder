STAGING_DIR="/tmp/staged/app"
INSTALLATION_DIR=$1
BINARY_VERSION=<%= binary_version %>
DEST_DIR=$INSTALLATION_DIR/httpd-${BINARY_VERSION}
FILENAME=httpd-${BINARY_VERSION}.tar.bz2
TAR_URL=https://archive.apache.org/dist/httpd//$FILENAME

function build_apr() {
  curl -f -L -O --retry 3 --connect-timeout 20 --retry-delay 1 "http://apache.mirrors.tds.net/apr/apr-<%= BUILD_VERSIONS[:apr_version] %>.tar.gz"
  tar zxf "apr-<%= BUILD_VERSIONS[:apr_version] %>.tar.gz"
  pushd "apr-<%= BUILD_VERSIONS[:apr_version] %>"
  ./configure --prefix="$STAGING_DIR/libapr-<%= BUILD_VERSIONS[:apr_version] %>"
  make -j 3
  make install
  popd
}

function build_apr_iconv() {
  curl -f -L -O --retry 3 --connect-timeout 20 --retry-delay 1 "http://apache.mirrors.tds.net/apr/apr-iconv-<%= BUILD_VERSIONS[:apr_iconv_version] %>.tar.gz"
  tar zxf "apr-iconv-<%= BUILD_VERSIONS[:apr_iconv_version] %>.tar.gz"
  pushd "apr-iconv-<%= BUILD_VERSIONS[:apr_iconv_version] %>"
  ./configure \
    --prefix="$STAGING_DIR/libapr-iconv-<%= BUILD_VERSIONS[:apr_iconv_version] %>" \
    --with-apr="$STAGING_DIR/libapr-<%= BUILD_VERSIONS[:apr_version] %>/bin/apr-1-config"
  make -j 3
  make install
  popd
}

function build_apr_util() {
  curl -f -L -O --retry 3 --connect-timeout 20 --retry-delay 1 "http://apache.mirrors.tds.net/apr/apr-util-<%= BUILD_VERSIONS[:apr_util_version] %>.tar.gz"
  tar zxf "apr-util-<%= BUILD_VERSIONS[:apr_util_version] %>.tar.gz"
  pushd "apr-util-<%= BUILD_VERSIONS[:apr_util_version] %>"
  ./configure \
    --prefix="$STAGING_DIR/libapr-util-<%= BUILD_VERSIONS[:apr_util_version] %>" \
    --with-iconv="$STAGING_DIR/libapr-iconv-$ICONV_VERSION" \
    --with-crypto \
    --with-openssl \
    --with-mysql \
    --with-pgsql \
    --with-gdbm \
    --with-ldap \
    --with-apr="$STAGING_DIR/libapr-<%= BUILD_VERSIONS[:apr_version] %>"
  make -j 3
  make install
  popd
}

function build_required_libs() {
  build_apr
  build_apr_iconv
  build_apr_util
}

template_steps() {
  # build required libs & httpd
  apt-get -y install libpcre3-dev
  build_required_libs

  ./configure \
    --prefix="/app/httpd" \
    --with-apr="$STAGING_DIR/libapr-<%= BUILD_VERSIONS[:apr_version] %>" \
    --with-apr-util="$STAGING_DIR/libapr-util-<%= BUILD_VERSIONS[:apr_util_version] %>" \
    --enable-mpms-shared="worker event" \
    --enable-mods-shared=reallyall \
    --disable-isapi \
    --disable-dav \
    --disable-dialup
  make -j 3
  make install prefix=$INSTALLATION_DIR/httpd

  # Remove unnecessary files and config
  cd $INSTALLATION_DIR/httpd
  rm -rf build/ cgi-bin/ error/ icons/ include/ man/ manual/ htdocs/
  rm -rf conf/extra/* conf/httpd.conf conf/httpd.conf.bak conf/magic conf/original

  # Install required libraries
  mkdir $INSTALLATION_DIR/httpd/lib
  cp "$STAGING_DIR/libapr-<%= BUILD_VERSIONS[:apr_version] %>/lib/libapr-1.so.0" $INSTALLATION_DIR/httpd/lib
  cp "$STAGING_DIR/libapr-util-<%= BUILD_VERSIONS[:apr_util_version] %>/lib/libaprutil-1.so.0" $INSTALLATION_DIR/httpd/lib
  cp "$STAGING_DIR/libapr-iconv-<%= BUILD_VERSIONS[:apr_iconv_version] %>/lib/libapriconv-1.so.0" $INSTALLATION_DIR/httpd/lib
}

main "$@"
