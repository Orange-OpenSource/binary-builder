#!/usr/bin/env ruby
# vi:syntax=ruby

versions = {}

`git grep Recipe.new`.split("\n").each do |line|
  m = line.match(%r{^(.*?):.*Recipe\.new\(['"](.*?)['"],\s*['"](.*?)['"]})
  next unless m
  versions[m[2]] ||= []
  versions[m[2]] << [ m[3], m[1] ]
end

`git grep standard_pecl`.split("\n").each do |line|
  m = line.match(%r{^(.*?):.*standard_pecl\(['"](.*?)['"],\s*['"](.*?)['"]})
  next unless m
  versions[m[2]] ||= []
  versions[m[2]] << [ m[3], m[1] ]
end

hardcoded = {
  'https://launchpad.net/libmemcached/+download' => 'memcached',
  'http://xcache.lighttpd.net/pub/Releases/' => 'lighthttpd',
  'http://www.lua.org/ftp/' => 'lua',
  'http://www.ioncube.com/loaders.php' => 'ioncube'
}
errors = []
packages = []
DATA.each do |line|
  line = line.chomp
  next if line == ""
  url, version, package = line.split(' | ', 2)
  version.gsub!(/^v/,'')
  if url && url.match(%r{https://pecl.php.net/package/(.*)})
    package = $1
  elsif url && url.match(%r{https://github.com/.*?/(.*)})
    package = $1
  elsif url && url.match(%r{http://downloads.datastax.com/cpp-driver/.*/(.*)/})
    package = $1
  elsif hardcoded[url]
    package = hardcoded[url]
  else
    errors << line
  end
  packages << [ package, version, url ] if package
end

packages.sort_by {|p,_,_|p}.each do |package, new_version, url|
  if versions[package]
    versions[package].each do |old_version, file|
      p [ package, new_version, old_version, file, url ] unless new_version == old_version
    end
  else
    puts "--- ERROR --- Missing package #{package} (#{url})"
  end
end

versions.each do |package, file|
  unless packages.detect { |p,_,_| p == package }
    puts "--- ERROR --- No new information for package #{package} (#{file})"
  end
end

if errors.size > 0
  puts "--- ERROR --- \n  "
  puts errors.join("\n  ")
end

__END__
https://pecl.php.net/package/protocolbuffers | 0.2.6
https://pecl.php.net/package/redis | 3.1.0
https://pecl.php.net/package/yaf | 3.0.4
https://pecl.php.net/package/lua | 2.0.2
https://launchpad.net/libmemcached/+download | 1.0.18
http://xcache.lighttpd.net/pub/Releases/ | 3.2.0
https://pecl.php.net/package/xhprof | 0.9.4
http://downloads.datastax.com/cpp-driver/ubuntu/14.04/cassandra/ | 2.5.0
http://downloads.datastax.com/cpp-driver/ubuntu/14.04/dependencies/libuv/ | 1.8.0
https://github.com/edenhill/librdkafka | v0.9.2
https://pecl.php.net/package/amqp | 1.7.1
https://pecl.php.net/package/cassandra | 1.2.2
https://pecl.php.net/package/gearman | 1.1.2
https://pecl.php.net/package/igbinary | 2.0.1
https://pecl.php.net/package/imagick | 3.4.3RC1
https://pecl.php.net/package/mailparse | 3.0.2
https://pecl.php.net/package/memcache | 2.2.7
https://pecl.php.net/package/mongo | 1.6.14
https://pecl.php.net/package/msgpack | 2.0.2
https://pecl.php.net/package/rdkafka | 3.0.0
https://pecl.php.net/package/solr | 2.4.0
https://pecl.php.net/package/sundown | 0.3.11
https://pecl.php.net/package/xdebug | 2.5.0
https://pecl.php.net/package/mongodb | 1.2.3
http://www.lua.org/ftp/ | 5.3.3
http://www.ioncube.com/loaders.php | 6.0.8
https://github.com/alanxz/rabbitmq-c | v0.8.0
https://github.com/redis/hiredis | v0.13.3
https://github.com/allegro/php-protobuf | v0.11.1
https://github.com/phalcon/cphalcon | v3.0.3
https://github.com/twigphp/twig | v2.1.0
https://github.com/stefanesser/suhosin | 0.9.38

